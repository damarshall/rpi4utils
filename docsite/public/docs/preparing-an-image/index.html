<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Preparing an Image - Raspberry Pi4 Cluster Docs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="/favicon.png">

  
  
  <link rel="stylesheet" href="/css/style.min.7dc335eda7504f93456161f5def735046a15346dd8ee25bedd7d902fbdb43776.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home">
      <a href="/">
        <span>Home</span>
      </a>
    </li>
    
    <li class="menu-item-docs">
      <a href="/docs/">
        <span>Docs</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="/"><img alt="Logo" src="/images/logo.svg" /></a>
    </div>
    <div class="logo-mobile">
      <a href="/"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home">
      <a href="/">
        <span>Home</span>
      </a>
    </li>
    
    <li class="menu-item-docs">
      <a href="/docs/">
        <span>Docs</span>
      </a>
    </li>
    
  </ul>
</div>
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <h4>Docs</h4>
  <ul>
    
    <li class="">
      <a href="/docs/getting-started/">Getting Started</a>
    </li>
    
    <li class="active ">
      <a href="/docs/preparing-an-image/">Preparing an Image</a>
    </li>
    
    <li class="">
      <a href="/docs/cloud-init/">cloud-init Bootstrapping</a>
    </li>
    
    <li class="">
      <a href="/docs/io-benchmarks/">I/O Benchmarks</a>
    </li>
    
    <li class="">
      <a href="/docs/cases-and-cooling/">Cases and Cooling</a>
    </li>
    
    <li class="">
      <a href="/docs/poe-testing/">PoE Testing</a>
    </li>
    
  </ul>
</div>

          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">Preparing an Image</h1>
<div class="content ">
  

<h1 id="preparing-a-bootable-ubuntu-18-04-3-image">Preparing a Bootable Ubuntu 18.04.3 Image</h1>

<p>N.B. the official Ubuntu supplied image is not RPi 4 compatible. We will take a copy of the current working firmware, take a copy of the Ubuntu pi3+ pre-installed server image and merge the two together.</p>

<p>We will be working on a 32-bit image (arch: armhf) as there are memory limitations on the 64-bit firmware code causing it to fail on boards with more than 1GB RAM configured.</p>

<p>Pi 4 firmware only supports booting from the microSD card at the time of writing (10-Aug-2019), so we will prepare a bootable image for a microSD card. With a single line change it can also be used to mount a USB3 drive as the root volume.</p>

<p>Retrieve current Pi4 compatible firmware as follows:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">wget https://codeload.github.com/raspberrypi/firmware/zip/master</code></pre></div>
<p>and the pre-installed Ubuntu rpi3 image:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">wget http://cdimage.ubuntu.com/ubuntu/releases/bionic/release/ubuntu-18.04.3-preinstalled-server-armhf+raspi3.img.xz</code></pre></div>
<p>To prepare a bootable Pi 4 image, proceed as follows:</p>

<ul>
<li>Unzip the firmware zip file</li>
<li>copy the image to another name:</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">unzip firmware-master.zip
cp ubuntu-18.04.3-preinstalled-server-armhf+raspi3.img.xz ubuntupi4.img.xz</code></pre></div>
<ul>
<li>uncompress the image we&rsquo;ll work on:</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">unxz ubuntupi4.img.xz</code></pre></div>
<ul>
<li>create loop devices for partitions in the image:</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo kpartx -av ubuntupi4.img</code></pre></div>
<ul>
<li>pay attention to the mapping devices created and mount the one for the first partition in the image (the first partition is the boot partition containing the firmware). N.B. the device has the prefix <code>/dev/mapper</code>:</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo mount -o loop /dev/mapper/loop26p1 /mnt</code></pre></div>
<ul>
<li>delete the contents of the firmware directory except for <code>cmdline.txt</code> and <code>config.txt</code> which should be preserved, and the contents of the overlay directory. Copy contents from <code>firmware-master/boot</code> to replace those in <code>/mnt</code> (don&rsquo;t forget to copy the contents of the overlay directory as well)</li>
<li>Unmount the loopback drive, remove the device mappings and compress the image:</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sync
sudo umount /mnt
sudo kpartx -d ubuntupi4.img
xz -vz ubuntupi4.img</code></pre></div>
<ul>
<li>You know have a Pi 4 image suitable for flashing onto a microSD card. An excellent tool for doing this is <a href="https://www.balena.io/etcher/">Balena Etcher</a>.</li>
</ul>

<p>You now have a bootable Ubuntu 18.04.3 image that will work with a Raspberry Pi 4, However to make this a stable and maintainable system you will need to do some additional work.</p>

<p>Rather than modify our base image, we use a <a href="https://cloudinit.readthedocs.io/en/latest/topics/capabilities.html">cloud-init</a> strategy to allow us to bootstrap and further customize our installed image by performing tasks on first boot. For details, see our <a href="cloud-init.html">cloud-init page</a>.</p>

<h2 id="more-on-kernel-boot-parameters">More on Kernel Boot Parameters</h2>

<p>Kernel boot parameters are passed via the file <code>cmdline.txt</code> located on the boot partition.</p>

<p>The stock value for this (which assumes booting from and using the microSD card as the root volume) is as follows:</p>
<div class="highlight"><pre class="chroma">net.ifnames=0 dwc_otg.lpm_enable=0 console=ttyAMA0,115200 console=tty1 root=/dev/mmcblk0p2 rootfstype=ext4 elevator=deadline rootwait</pre></div>
<p>When preparing a configuration to boot from microSD but use a USB3 drive as the root volume (for better performance and more storage) modify the <code>root=</code> parameter to <code>root=/dev/sda2</code> (assuming your root partition is the 2nd on the drive which will be the case if you use the image we prepared above). So the modified contents of <code>cmdline.txt</code> are:</p>
<div class="highlight"><pre class="chroma">net.ifnames=0 dwc_otg.lpm_enable=0 console=ttyAMA0,115200 console=tty1 root=/dev/sda2 rootfstype=ext4 elevator=deadline rootwait</pre></div>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.1237ff71925bb8625c97a9af8db4c54525258bedfd7c47493daaff723bea755e.js"></script>
  

  
  
  
    
  


</body>

</html>
